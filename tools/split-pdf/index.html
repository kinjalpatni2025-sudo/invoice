<script src="https://unpkg.com/pdf-lib@^1.17.1/dist/pdf-lib.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
// Set PDF.js worker path
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

const input = document.getElementById('fileInput');
const drop = document.getElementById('dropZone');
const pagesDiv = document.getElementById('pages');
const exportBtn = document.getElementById('exportBtn');
let pdfDoc = null, selectedPages = [], fileBytes = null;

// Handle file input
input.addEventListener('change', e => {
  if (e.target.files.length) loadPDF(e.target.files[0]);
});

// Drag drop
['dragover', 'dragenter'].forEach(ev => {
  drop.addEventListener(ev, e => {
    e.preventDefault();
    drop.classList.add('drag');
  });
});

['dragleave', 'drop'].forEach(ev => {
  drop.addEventListener(ev, e => {
    e.preventDefault();
    drop.classList.remove('drag');
  });
});

drop.addEventListener('drop', e => {
  if (e.dataTransfer.files.length) loadPDF(e.dataTransfer.files[0]);
});

// Load PDF and render thumbnails
async function loadPDF(file) {
  try {
    if (!file.name.toLowerCase().endsWith('.pdf')) {
      alert('Only PDF files are allowed');
      return;
    }
    
    fileBytes = await file.arrayBuffer();
    const loadingTask = pdfjsLib.getDocument({ data: fileBytes });
    pdfDoc = await loadingTask.promise;
    
    pagesDiv.innerHTML = '';
    selectedPages = [];
    exportBtn.style.display = 'none';
    
    // Render all pages
    for (let p = 1; p <= pdfDoc.numPages; p++) {
      try {
        const page = await pdfDoc.getPage(p);
        const viewport = page.getViewport({ scale: 0.3 });
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.height = viewport.height;
        canvas.width = viewport.width;
        
        await page.render({
          canvasContext: ctx,
          viewport: viewport
        }).promise;
        
        const thumb = document.createElement('div');
        thumb.className = 'page-thumb';
        thumb.innerHTML = `
          <img src="${canvas.toDataURL()}">
          <div style="text-align:center;font-size:12px;color:#ccc">${p}</div>
        `;
        
        thumb.addEventListener('click', () => {
          thumb.classList.toggle('selected');
          const index = selectedPages.indexOf(p);
          
          if (index > -1) {
            selectedPages.splice(index, 1);
          } else {
            selectedPages.push(p);
          }
          
          exportBtn.style.display = selectedPages.length ? 'inline-flex' : 'none';
        });
        
        pagesDiv.appendChild(thumb);
      } catch (err) {
        console.error(`Error rendering page ${p}:`, err);
      }
    }
  } catch (err) {
    console.error('Error loading PDF:', err);
    alert('Error loading PDF. Please try another file.');
  }
}

// Export selected pages
exportBtn.addEventListener('click', async () => {
  if (!selectedPages.length) return;
  
  try {
    exportBtn.disabled = true;
    exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
    
    const srcPdf = await PDFLib.PDFDocument.load(fileBytes);
    const newPdf = await PDFLib.PDFDocument.create();
    
    // Sort pages to maintain original order
    const sortedPages = [...selectedPages].sort((a, b) => a - b);
    
    for (const p of sortedPages) {
      try {
        const [copiedPage] = await newPdf.copyPages(srcPdf, [p - 1]);
        newPdf.addPage(copiedPage);
      } catch (err) {
        console.error(`Error copying page ${p}:`, err);
      }
    }
    
    const bytes = await newPdf.save();
    const blob = new Blob([bytes], { type: 'application/pdf' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'split_pages.pdf';
    a.click();
    
    // Clean up
    URL.revokeObjectURL(url);
  } catch (err) {
    console.error('Error exporting PDF:', err);
    alert('Error exporting PDF. Please try again.');
  } finally {
    exportBtn.disabled = false;
    exportBtn.innerHTML = '<i class="fa fa-download"></i> Export Selected Pages';
  }
});
</script>
