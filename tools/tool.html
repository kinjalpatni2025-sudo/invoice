<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SmartTool Hub — Tool</title>
  <meta name="description" content="All SmartTool Hub browser tools in a single page."/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
  <!-- pdf-lib for PDF operations -->
  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
  <!-- pdf.js for rendering PDF pages to canvas (for PDF->Image) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.8.162/pdf.min.js"></script>
  <!-- qrcode library -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <style>
    :root{
      --bg:#0b1220;--card:#0f1724;--muted:#94a3b8;--accent:#6366f1;
    }
    body{margin:0;font-family:Inter,Arial,sans-serif;background:linear-gradient(180deg,#0f172a,#071022);color:#e6eef8}
    .wrap{max-width:980px;margin:18px auto;padding:18px}
    header{display:flex;gap:12px;align-items:center;margin-bottom:14px}
    header h1{margin:0;font-size:1.05rem}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin:14px 0}
    .toolbtn{padding:8px 10px;border-radius:8px;background:#111827;border:1px solid rgba(255,255,255,0.03);cursor:pointer}
    .toolbtn.active{box-shadow:0 8px 22px rgba(99,102,241,0.16);background:linear-gradient(90deg,#6366f1,#06b6d4)}
    .panel{background:rgba(255,255,255,0.02);padding:16px;border-radius:12px;margin-top:12px}
    label{display:block;margin:8px 0 6px;color:var(--muted);font-size:0.9rem}
    input[type="file"]{display:block}
    input[type="text"], textarea, select, input[type="number"]{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:#0b1220;color:inherit}
    button.primary{background:var(--accent);color:white;padding:10px 12px;border:0;border-radius:8px;cursor:pointer}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{flex:1;min-width:200px}
    .result{margin-top:12px}
    canvas{max-width:100%;border-radius:8px}
    pre{background:#071024;padding:10px;border-radius:8px;overflow:auto;color:#cbd5e1}
    .small{font-size:0.9rem;color:var(--muted)}
    footer{margin-top:18px;color:var(--muted);font-size:0.9rem}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <img src="/favicon.ico" alt="" style="width:44px;height:44px;border-radius:8px;margin-right:10px"/>
      <div>
        <h1>SmartTool Hub — Tools</h1>
        <div class="small">All tools run locally in your browser. Choose a tool from above or use ?tool=slug in URL.</div>
      </div>
    </header>

    <div class="toolbar" id="toolbar">
      <!-- buttons created dynamically -->
    </div>

    <div id="ui" class="panel">
      <!-- dynamic tool UI rendered here -->
    </div>

    <footer>
      Tip: Use the search in the header page to jump to the tool, or open direct link: <span id="toolSlug" class="small"></span>
    </footer>
  </div>

<script>
/*
  Single-file multi-tool app.
  Map slug -> {title, category, render: function(container)}
  Each render sets innerHTML and binds events.
*/

// Utility helpers
const $ = sel => document.querySelector(sel);
const qs = (root, sel) => (root||document).querySelector(sel);
const readFileAsArrayBuffer = f => new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsArrayBuffer(f)});
const readFileAsText = f => new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsText(f)});
const download = (blob, name) => {
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href=url; a.download=name; document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(url),2000);
};

// Tool definitions (33)
const tools = {
  // PDF Tools
  "image-to-pdf": {
    title: "Image → PDF",
    desc: "Convert images to a single PDF (local).",
    render: async (root)=>{
      root.innerHTML = `
        <h2>Image to PDF</h2>
        <label>Select images (PNG/JPG)</label>
        <input type="file" id="imgs" accept="image/*" multiple/>
        <div class="result" id="imgpdfResult"></div>
      `;
      qs(root,'#imgs').onchange = async e=>{
        const files = Array.from(e.target.files);
        if(!files.length) return;
        const pdfDoc = PDFLib.PDFDocument.create();
        for(const f of files){
          const arr = await readFileAsArrayBuffer(f);
          const img = await pdfDoc.embedJpg(arr).catch(async ()=>{
            try{ return await pdfDoc.embedPng(arr) } catch(err){ throw err; }
          });
          const page = pdfDoc.addPage([img.width, img.height]);
          page.drawImage(img, {x:0,y:0,width:img.width,height:img.height});
        }
        const pdfBytes = await pdfDoc.save();
        download(new Blob([pdfBytes],{type:'application/pdf'}), 'images.pdf');
        qs(root,'#imgpdfResult').innerHTML = '<div class="small">Downloaded images.pdf</div>';
      }
    }
  },

  "pdf-merge": {
    title: "Merge PDFs",
    desc: "Merge multiple PDFs locally.",
    render: (root)=>{
      root.innerHTML = `
        <h2>Merge PDFs</h2>
        <label>Select PDF files (order will be preserved)</label>
        <input type="file" id="mergeFiles" accept="application/pdf" multiple/>
        <div class="result" id="mergeResult"></div>
      `;
      qs(root,'#mergeFiles').onchange = async e=>{
        const files = Array.from(e.target.files);
        if(files.length < 2){ qs(root,'#mergeResult').innerHTML = '<div class="small">Select 2 or more PDFs.</div>'; return;}
        const outDoc = await PDFLib.PDFDocument.create();
        for(const f of files){
          const bytes = await readFileAsArrayBuffer(f);
          const src = await PDFLib.PDFDocument.load(bytes);
          const copied = await outDoc.copyPages(src, src.getPageIndices());
          copied.forEach(p=>outDoc.addPage(p));
        }
        const out = await outDoc.save();
        download(new Blob([out],{type:'application/pdf'}),'merged.pdf');
        qs(root,'#mergeResult').innerHTML = '<div class="small">Downloaded merged.pdf</div>';
      }
    }
  },

  "pdf-split": {
    title: "Split PDF",
    desc: "Split PDF into single pages or ranges.",
    render: (root)=>{
      root.innerHTML = `
        <h2>Split PDF</h2>
        <label>Select a PDF</label>
        <input type="file" id="splitFile" accept="application/pdf"/>
        <label>Pages (e.g. 1-3,5 or leave empty for all single pages)</label>
        <input id="splitRanges" type="text" placeholder="1-2,4,6-7"/>
        <div><button id="splitBtn" class="primary">Split</button></div>
        <div class="result" id="splitResult"></div>
      `;
      qs(root,'#splitBtn').onclick = async ()=>{
        const f = qs(root,'#splitFile').files[0];
        if(!f) return alert('Select file');
        const arr = await readFileAsArrayBuffer(f);
        const src = await PDFLib.PDFDocument.load(arr);
        const total = src.getPageCount();
        let ranges = qs(root,'#splitRanges').value.trim();
        const outDoc = await PDFLib.PDFDocument.create();
        if(!ranges){
          // create single-page PDFs and zip? For simplicity make single pdf per selection: here create one per page and download sequentially
          for(let i=0;i<total;i++){
            const doc2 = await PDFLib.PDFDocument.create();
            const [p] = await doc2.copyPages(src,[i]);
            doc2.addPage(p);
            const out = await doc2.save();
            download(new Blob([out],{type:'application/pdf'}),`page-${i+1}.pdf`);
          }
          qs(root,'#splitResult').innerHTML = `<div class="small">Downloaded ${total} single-page PDFs</div>`;
          return;
        }
        // parse ranges and create combined doc
        const rangesList = ranges.split(',').map(r=>r.split('-').map(x=>parseInt(x.trim())));
        for(const r of rangesList){
          if(r.length===1){ 
            const pageIndex = r[0]-1;
            if(pageIndex>=0 && pageIndex<total){
              const [p] = await outDoc.copyPages(src,[pageIndex]); outDoc.addPage(p);
            }
          } else {
            const start=r[0]-1, end=r[1]-1;
            for(let i=start;i<=end;i++){
              if(i>=0 && i<total){ const [p]=await outDoc.copyPages(src,[i]); outDoc.addPage(p); }
            }
          }
        }
        const out = await outDoc.save();
        download(new Blob([out],{type:'application/pdf'}),'split-output.pdf');
        qs(root,'#splitResult').innerHTML = `<div class="small">Downloaded split-output.pdf</div>`;
      }
    }
  },

  "pdf-compress": {
    title: "Compress PDF",
    desc: "Compress PDF by downsampling images (basic).",
    render: (root)=>{
      root.innerHTML = `
        <h2>Compress PDF (basic)</h2>
        <label>Select PDF</label>
        <input type="file" id="compressFile" accept="application/pdf"/>
        <label>Image max width (px) — lower => smaller file</label>
        <input type="number" id="maxW" value="1000" />
        <div><button id="compressBtn" class="primary">Compress</button></div>
        <div class="result" id="compressResult"></div>
      `;
      qs(root,'#compressBtn').onclick = async ()=>{
        const f = qs(root,'#compressFile').files[0]; if(!f) return alert('Select file');
        const maxW = parseInt(qs(root,'#maxW').value) || 1000;
        // basic approach: render each page to canvas via pdf.js then repack images into pdf-lib pages
        const data = await readFileAsArrayBuffer(f);
        const pdf = await pdfjsLib.getDocument({data}).promise;
        const outDoc = await PDFLib.PDFDocument.create();
        for(let i=1;i<=pdf.numPages;i++){
          const page = await pdf.getPage(i);
          const viewport = page.getViewport({scale:1});
          const scale = Math.min(1, maxW/viewport.width);
          const vp = page.getViewport({scale});
          const canvas = document.createElement('canvas');
          canvas.width = Math.floor(vp.width);
          canvas.height = Math.floor(vp.height);
          const ctx = canvas.getContext('2d');
          await page.render({canvasContext:ctx,viewport:vp}).promise;
          const dataUrl = canvas.toDataURL('image/jpeg',0.7);
          const imgBytes = atob(dataUrl.split(',')[1]).split('').map(c=>c.charCodeAt(0));
          const imgUint8 = new Uint8Array(imgBytes);
          const jpg = await outDoc.embedJpg(imgUint8);
          const p = outDoc.addPage([jpg.width, jpg.height]);
          p.drawImage(jpg,{x:0,y:0,width:jpg.width,height:jpg.height});
        }
        const out = await outDoc.save();
        download(new Blob([out],{type:'application/pdf'}),'compressed.pdf');
        qs(root,'#compressResult').innerHTML = `<div class="small">Downloaded compressed.pdf</div>`;
      }
    }
  },

  "pdf-rotate": {
    title: "Rotate PDF",
    desc: "Rotate pages in a PDF.",
    render: (root)=>{
      root.innerHTML = `
        <h2>Rotate PDF Pages</h2>
        <label>Select PDF</label>
        <input type="file" id="rotateFile" accept="application/pdf"/>
        <label>Rotate degrees (90/180/270)</label>
        <select id="rotateDeg"><option>90</option><option>180</option><option>270</option></select>
        <div><button id="rotateBtn" class="primary">Rotate</button></div>
        <div class="result" id="rotateResult"></div>
      `;
      qs(root,'#rotateBtn').onclick = async ()=>{
        const f = qs(root,'#rotateFile').files[0]; if(!f) return alert('Select file');
        const deg = parseInt(qs(root,'#rotateDeg').value);
        const arr = await readFileAsArrayBuffer(f);
        const doc = await PDFLib.PDFDocument.load(arr);
        const pages = doc.getPages();
        const rotateMap = {90:PDFLib.degrees(90),180:PDFLib.degrees(180),270:PDFLib.degrees(270)};
        pages.forEach(p=>p.setRotation(rotateMap[deg]));
        const out = await doc.save();
        download(new Blob([out],{type:'application/pdf'}),'rotated.pdf');
        qs(root,'#rotateResult').innerHTML = `<div class="small">Downloaded rotated.pdf</div>`;
      }
    }
  },

  "pdf-unlock": {
    title: "Unlock PDF (if owner password known)",
    desc: "Remove owner password if you provide it.",
    render: (root)=>{
      root.innerHTML = `
        <h2>Unlock PDF</h2>
        <label>Select password-protected PDF</label>
        <input type="file" id="unlockFile" accept="application/pdf"/>
        <label>Enter password (if known)</label>
        <input type="text" id="unlockPwd"/>
        <div><button id="unlockBtn" class="primary">Unlock</button></div>
        <div class="result" id="unlockResult"></div>
      `;
      qs(root,'#unlockBtn').onclick = async ()=>{
        const f = qs(root,'#unlockFile').files[0]; if(!f) return alert('Select file');
        const pwd = qs(root,'#unlockPwd').value || '';
        try{
          const arr = await readFileAsArrayBuffer(f);
          // pdf-lib cannot open encrypted PDFs yet reliably. Try pdf.js to load with password
          const pdf = await pdfjsLib.getDocument({data:arr, password: pwd}).promise;
          // If loaded, create a new doc by copying pages
          const outDoc = await PDFLib.PDFDocument.create();
          const srcDoc = await PDFLib.PDFDocument.load(arr).catch(()=>null);
          if(srcDoc){
            const copied = await outDoc.copyPages(srcDoc, srcDoc.getPageIndices());
            copied.forEach(p=>outDoc.addPage(p));
            const out = await outDoc.save();
            download(new Blob([out],{type:'application/pdf'}),'unlocked.pdf');
            qs(root,'#unlockResult').innerHTML = `<div class="small">Downloaded unlocked.pdf</div>`;
          } else {
            qs(root,'#unlockResult').innerHTML = `<div class="small">Cannot remove encryption in-browser for this file.</div>`;
          }
        } catch(err){
          alert('Failed to open PDF. Wrong password or encrypted in unsupported way.');
          console.error(err);
        }
      }
    }
  },

  "pdf-password": {
    title: "Password Protect PDF",
    desc: "Add (owner) password — basic (not highly secure) encryption.",
    render: (root)=>{
      root.innerHTML = `
        <h2>Password Protect PDF</h2>
        <label>Select PDF</label>
        <input type="file" id="pwdFile" accept="application/pdf"/>
        <label>Password to set</label>
        <input id="pwdSet" type="text"/>
        <div><button id="pwdBtn" class="primary">Protect</button></div>
        <div class="result" id="pwdResult"></div>
      `;
      qs(root,'#pwdBtn').onclick = async ()=>{
        const f = qs(root,'#pwdFile').files[0]; if(!f) return alert('Select file');
        const pwd = qs(root,'#pwdSet').value || '';
        // Note: pdf-lib doesn't support encryption; true protection needs server-side or other libs.
        // Here we will attach a simple "wrapper" PDF with instructions (not real encryption).
        alert('In-browser strong password-protection is limited. Consider server-side encryption. This tool will add a cover page indicating protection, but will not encrypt the file.');
        const arr = await readFileAsArrayBuffer(f);
        const doc = await PDFLib.PDFDocument.load(arr);
        const cover = doc.addPage([400,200]);
        cover.drawText(`Protected with password: ${pwd}`, {x:20,y:150,size:12});
        const out = await doc.save();
        download(new Blob([out],{type:'application/pdf'}),'protected.pdf');
        qs(root,'#pwdResult').innerHTML = `<div class="small">Downloaded protected.pdf (wrapper only)</div>`;
      }
    }
  },

  "pdf-edit": {
    title: "Edit PDF (annotate text)",
    desc: "Add text annotation to a PDF page.",
    render: (root)=>{
      root.innerHTML = `
        <h2>Edit PDF (Add Text)</h2>
        <label>Select PDF</label>
        <input type="file" id="editFile" accept="application/pdf"/>
        <label>Text to add</label><input id="editText" type="text" placeholder="Annotation text"/>
        <label>Page number (1-based)</label><input id="editPage" type="number" value="1"/>
        <div><button id="editBtn" class="primary">Add Text</button></div>
        <div class="result" id="editResult"></div>
      `;
      qs(root,'#editBtn').onclick = async ()=>{
        const f = qs(root,'#editFile').files[0]; if(!f) return alert('Select file');
        const text = qs(root,'#editText').value || '';
        const pageNum = parseInt(qs(root,'#editPage').value)||1;
        const arr = await readFileAsArrayBuffer(f);
        const doc = await PDFLib.PDFDocument.load(arr);
        const pages = doc.getPages();
        const idx = Math.max(0, Math.min(pages.length-1, pageNum-1));
        pages[idx].drawText(text, {x:40,y:40,size:12,color:PDFLib.rgb(0,0.53,0.71)});
        const out = await doc.save();
        download(new Blob([out],{type:'application/pdf'}),'edited.pdf');
        qs(root,'#editResult').innerHTML = `<div class="small">Downloaded edited.pdf</div>`;
      }
    }
  },

  "pdf-to-image": {
    title: "PDF → Image",
    desc: "Render PDF pages to PNG/JPG",
    render: (root)=>{
      root.innerHTML = `
        <h2>PDF to Image</h2>
        <label>Select PDF</label><input type="file" id="pdf2img" accept="application/pdf"/>
        <label>Scale (1 for original)</label><input type="number" id="pdfScale" value="1" step="0.1"/>
        <div><button id="pdf2imgBtn" class="primary">Convert</button></div>
        <div id="pdf2imgResult" class="result"></div>
      `;
      qs(root,'#pdf2imgBtn').onclick = async ()=>{
        const f = qs(root,'#pdf2img').files[0]; if(!f) return alert('Select file');
        const scale = parseFloat(qs(root,'#pdfScale').value)||1;
        const arr = await readFileAsArrayBuffer(f);
        const pdf = await pdfjsLib.getDocument({data:arr}).promise;
        const outDiv = qs(root,'#pdf2imgResult'); outDiv.innerHTML='';
        for(let i=1;i<=pdf.numPages;i++){
          const page = await pdf.getPage(i);
          const vp = page.getViewport({scale});
          const canvas = document.createElement('canvas');
          canvas.width = vp.width; canvas.height = vp.height;
          await page.render({canvasContext: canvas.getContext('2d'), viewport: vp}).promise;
          const url = canvas.toDataURL('image/png');
          const img = document.createElement('img'); img.src=url; img.style.maxWidth='100%';
          const dl = document.createElement('button'); dl.textContent='Download PNG'; dl.className='primary';
          dl.onclick = ()=> download(dataURLToBlob(url),'page-'+i+'.png');
          const card = document.createElement('div'); card.style.margin='12px 0';
          card.appendChild(img); card.appendChild(dl);
          outDiv.appendChild(card);
        }
      }
      function dataURLToBlob(dataurl) {
        const parts = dataurl.split(','), mime = parts[0].match(/:(.*?);/)[1];
        const bstr = atob(parts[1]); let n = bstr.length; const u8 = new Uint8Array(n);
        while(n--) u8[n] = bstr.charCodeAt(n);
        return new Blob([u8], {type:mime});
      }
    }
  },

  // IMAGE Tools
  "image-to-png-jpg": {
    title: "Image → PNG/JPG",
    desc: "Convert images between PNG and JPG using canvas.",
    render: (root)=>{
      root.innerHTML = `
        <h2>Image to PNG/JPG</h2>
        <label>Select image</label><input type="file" id="imgConv" accept="image/*"/>
        <label>Output format</label>
        <select id="imgFormat"><option value="image/png">PNG</option><option value="image/jpeg">JPG</option></select>
        <div><button id="imgConvBtn" class="primary">Convert</button></div>
        <div id="imgConvResult" class="result"></div>
      `;
      qs(root,'#imgConvBtn').onclick = async ()=>{
        const f = qs(root,'#imgConv').files[0]; if(!f) return alert('Select image');
        const url = URL.createObjectURL(f);
        const img = new Image();
        img.onload = ()=>{
          const canvas=document.createElement('canvas');
          canvas.width=img.width; canvas.height=img.height;
          const ctx=canvas.getContext('2d'); ctx.drawImage(img,0,0);
          const fmt = qs(root,'#imgFormat').value;
          const dataurl = canvas.toDataURL(fmt,0.92);
          const a=document.createElement('a'); a.href=dataurl; a.download='converted.'+(fmt.includes('png')?'png':'jpg'); a.click();
          qs(root,'#imgConvResult').innerHTML = `<div class="small">Downloaded converted image.</div>`;
          URL.revokeObjectURL(url);
        }
        img.src = url;
      }
    }
  },

  "jpg-to-png": { title:"JPG→PNG", render: (r)=> tools["image-to-png-jpg"].render(r) },
  "png-to-jpg": { title:"PNG→JPG", render: (r)=> tools["image-to-png-jpg"].render(r) },

  "image-resize": {
    title:"Resize Image",
    desc:"Resize by width/height (maintain aspect)",
    render: (root)=>{
      root.innerHTML = `
        <h2>Resize Image</h2>
        <label>Select image</label><input type="file" id="resizeImg" accept="image/*"/>
        <label>New width (px, leave empty to auto)</label><input id="newW" type="number" placeholder="e.g. 800"/>
        <label>New height (px, leave empty to auto)</label><input id="newH" type="number" placeholder="e.g. 600"/>
        <div><button id="resizeBtn" class="primary">Resize</button></div>
        <div id="resizeResult" class="result"></div>
      `;
      qs(root,'#resizeBtn').onclick = async ()=>{
        const f = qs(root,'#resizeImg').files[0]; if(!f) return alert('Select');
        const url=URL.createObjectURL(f); const img=new Image();
        img.onload = ()=>{
          let nw = parseInt(qs(root,'#newW').value)||null;
          let nh = parseInt(qs(root,'#newH').value)||null;
          if(!nw && !nh){ nw = img.width; nh = img.height; }
          if(!nw) nw = Math.round(img.width * (nh / img.height));
          if(!nh) nh = Math.round(img.height * (nw / img.width));
          const c=document.createElement('canvas'); c.width=nw; c.height=nh;
          c.getContext('2d').drawImage(img,0,0,nw,nh);
          const data=c.toDataURL('image/png');
          const a=document.createElement('a'); a.href=data; a.download='resized.png'; a.click();
          qs(root,'#resizeResult').innerHTML = `<div class="small">Downloaded resized image.</div>`;
          URL.revokeObjectURL(url);
        }
        img.src=url;
      }
    }
  },

  "image-crop": {
    title:"Crop Image",
    desc:"Basic crop: specify rectangle",
    render: (root)=>{
      root.innerHTML = `
        <h2>Crop Image</h2>
        <label>Select image</label><input type="file" id="cropImg" accept="image/*"/>
        <label>Crop X Y Width Height (px, comma separated)</label><input id="cropRect" placeholder="10,10,200,150"/>
        <div><button id="cropBtn" class="primary">Crop</button></div>
        <div id="cropResult" class="result"></div>
      `;
      qs(root,'#cropBtn').onclick = async ()=>{
        const f = qs(root,'#cropImg').files[0]; if(!f) return alert('Select');
        const rect = (qs(root,'#cropRect').value||'').split(',').map(s=>parseInt(s.trim()));
        if(rect.length<4) return alert('Enter 4 numbers');
        const url=URL.createObjectURL(f); const img=new Image();
        img.onload = ()=>{
          const c=document.createElement('canvas'); c.width=rect[2]; c.height=rect[3];
          c.getContext('2d').drawImage(img, rect[0], rect[1], rect[2], rect[3], 0,0,rect[2],rect[3]);
          const data=c.toDataURL('image/png'); const a=document.createElement('a'); a.href=data; a.download='cropped.png'; a.click();
          qs(root,'#cropResult').innerHTML = `<div class="small">Downloaded cropped image.</div>`;
          URL.revokeObjectURL(url);
        }
        img.src=url;
      }
    }
  },

  "image-flip-rotate": {
    title:"Flip/Rotate Image",
    desc:"Flip horizontally/vertically or rotate 90/180/270",
    render:(root)=>{
      root.innerHTML=`
        <h2>Flip / Rotate Image</h2>
        <label>Select image</label><input id="frImg" type="file" accept="image/*"/>
        <label>Operation</label>
        <select id="frOp"><option value="flipH">Flip Horizontal</option><option value="flipV">Flip Vertical</option><option value="rot90">Rotate 90</option><option value="rot180">Rotate 180</option><option value="rot270">Rotate 270</option></select>
        <div><button id="frBtn" class="primary">Apply</button></div><div id="frRes" class="result"></div>
      `;
      qs(root,'#frBtn').onclick = async ()=>{
        const f = qs(root,'#frImg').files[0]; if(!f) return alert('Select');
        const op = qs(root,'#frOp').value; const url=URL.createObjectURL(f); const img=new Image();
        img.onload = ()=>{
          let w=img.width,h=img.height, cw=w, ch=h, rot=0, flipH=false, flipV=false;
          if(op==='flipH') flipH=true;
          if(op==='flipV') flipV=true;
          if(op==='rot90'){ rot=90; cw=h; ch=w; }
          if(op==='rot180'){ rot=180; }
          if(op==='rot270'){ rot=270; cw=h; ch=w; }
          const c=document.createElement('canvas'); c.width=cw; c.height=ch;
          const ctx=c.getContext('2d');
          ctx.save();
          // handle rotation
          if(rot) { ctx.translate(cw/2,ch/2); ctx.rotate(rot*Math.PI/180); ctx.translate(-w/2,-h/2); }
          // handle flips
          if(flipH||flipV){
            ctx.translate(flipH? w:0, flipV? h:0);
            ctx.scale(flipH?-1:1, flipV?-1:1);
          }
          ctx.drawImage(img,0,0);
          ctx.restore();
          const data=c.toDataURL('image/png'); const a=document.createElement('a'); a.href=data; a.download='out.png'; a.click();
          qs(root,'#frRes').innerHTML = `<div class="small">Downloaded image.</div>`;
          URL.revokeObjectURL(url);
        }
        img.src=url;
      }
    }
  },

  "image-watermark": {
    title:"Add Watermark to Image",
    desc:"Add text or image watermark",
    render: (root)=>{
      root.innerHTML = `
        <h2>Image Watermark</h2>
        <label>Select base image</label><input id="wmImg" type="file" accept="image/*"/>
        <label>Watermark text</label><input id="wmText" type="text" placeholder="© MyBrand"/>
        <label>Opacity (0..1)</label><input id="wmOpacity" type="number" step="0.1" value="0.4"/>
        <div><button id="wmBtn" class="primary">Apply Watermark</button></div>
        <div id="wmRes" class="result"></div>
      `;
      qs(root,'#wmBtn').onclick = async ()=>{
        const f = qs(root,'#wmImg').files[0]; if(!f) return alert('Select');
        const txt = qs(root,'#wmText').value || '';
        const op = parseFloat(qs(root,'#wmOpacity').value) || 0.4;
        const url=URL.createObjectURL(f); const img=new Image();
        img.onload = ()=>{
          const c=document.createElement('canvas'); c.width=img.width; c.height=img.height;
          const ctx=c.getContext('2d'); ctx.drawImage(img,0,0);
          ctx.globalAlpha = op;
          ctx.font = Math.max(20, Math.round(img.width/20)) + 'px serif';
          ctx.fillStyle='white'; ctx.textBaseline='middle';
          const textWidth = ctx.measureText(txt).width;
          ctx.fillText(txt, img.width - textWidth - 20, img.height - 40);
          const data=c.toDataURL('image/png'); const a=document.createElement('a'); a.href=data; a.download='watermarked.png'; a.click();
          qs(root,'#wmRes').innerHTML = `<div class="small">Downloaded watermarked image.</div>`;
          URL.revokeObjectURL(url);
        }
        img.src=url;
      }
    }
  },

  "image-effects": {
    title:"Image Filter Effects",
    desc:"Apply grayscale, sepia, blur, invert",
    render:(root)=>{
      root.innerHTML = `
        <h2>Image Filter Effects</h2>
        <label>Select image</label><input id="fxImg" type="file" accept="image/*"/>
        <label>Filter</label>
        <select id="fxSel"><option value="none">None</option><option value="grayscale">Grayscale</option><option value="sepia">Sepia</option><option value="invert">Invert</option><option value="blur">Blur</option></select>
        <div><button id="fxBtn" class="primary">Apply</button></div>
        <div id="fxRes" class="result"></div>
      `;
      qs(root,'#fxBtn').onclick = async ()=>{
        const f = qs(root,'#fxImg').files[0]; if(!f) return alert('Select');
        const filter = qs(root,'#fxSel').value; const url=URL.createObjectURL(f); const img=new Image();
        img.onload = ()=>{
          const c=document.createElement('canvas'); c.width=img.width; c.height=img.height;
          const ctx=c.getContext('2d');
          ctx.filter = filter==='none' ? 'none' : filter==='blur' ? 'blur(4px)' : (filter==='grayscale'?'grayscale(1)':filter==='sepia'?'sepia(1)':'invert(1)');
          ctx.drawImage(img,0,0);
          const data=c.toDataURL('image/png'); const a=document.createElement('a'); a.href=data; a.download='effect.png'; a.click();
          qs(root,'#fxRes').innerHTML = `<div class="small">Downloaded image with effect.</div>`;
          URL.revokeObjectURL(url);
        }
        img.src=url;
      }
    }
  },

  // TEXT & URL Tools
  "base64": {
    title:"Base64 Encode/Decode",
    render:(root)=>{
      root.innerHTML = `
        <h2>Base64 Encode / Decode</h2>
        <label>Input text</label><textarea id="b64in" rows="6"></textarea>
        <div style="margin-top:8px"><button id="b64enc" class="primary">Encode</button> <button id="b64dec" class="toolbtn">Decode</button></div>
        <div id="b64out" class="result"></div>
      `;
      qs(root,'#b64enc').onclick = ()=> {
        const s = qs(root,'#b64in').value || '';
        try { qs(root,'#b64out').innerHTML = `<pre>${btoa(unescape(encodeURIComponent(s)))}</pre>`; } catch(e){ qs(root,'#b64out').innerHTML='<div class="small">Encoding error</div>';}
      };
      qs(root,'#b64dec').onclick = ()=> {
        const s = qs(root,'#b64in').value || '';
        try { qs(root,'#b64out').innerHTML = `<pre>${decodeURIComponent(escape(atob(s)))}</pre>`; } catch(e){ qs(root,'#b64out').innerHTML='<div class="small">Decoding error</div>';}
      }
    }
  },

  "url-encode-decode": {
    title:"URL Encode/Decode",
    render:(root)=>{
      root.innerHTML = `
        <h2>URL Encode / Decode</h2>
        <label>Input text / URL</label><input id="urltxt" type="text"/>
        <div style="margin-top:8px"><button id="urlenc" class="primary">Encode</button> <button id="urldec" class="toolbtn">Decode</button></div>
        <div id="urlout" class="result"></div>
      `;
      qs(root,'#urlenc').onclick = ()=> { qs(root,'#urlout').innerHTML = `<pre>${encodeURIComponent(qs(root,'#urltxt').value||'')}</pre>`;}
      qs(root,'#urldec').onclick = ()=> { try{qs(root,'#urlout').innerHTML = `<pre>${decodeURIComponent(qs(root,'#urltxt').value||'')}</pre>`}catch(e){qs(root,'#urlout').innerHTML='<div class="small">Decode error</div>'}}
    }
  },

  "case-converter": {
    title:"Case Converter",
    render:(root)=> {
      root.innerHTML = `
        <h2>Case Converter</h2>
        <label>Input text</label><textarea id="caseIn" rows="6"></textarea>
        <div style="margin-top:8px">
          <button id="upper" class="primary">UPPERCASE</button>
          <button id="lower" class="toolbtn">lowercase</button>
          <button id="title" class="toolbtn">Title Case</button>
        </div>
        <div id="caseOut" class="result"></div>
      `;
      qs(root,'#upper').onclick = ()=> qs(root,'#caseOut').innerHTML = `<pre>${qs(root,'#caseIn').value.toUpperCase()}</pre>`;
      qs(root,'#lower').onclick = ()=> qs(root,'#caseOut').innerHTML = `<pre>${qs(root,'#caseIn').value.toLowerCase()}</pre>`;
      qs(root,'#title').onclick = ()=> {
        const s = qs(root,'#caseIn').value.toLowerCase().replace(/\b\w/g,c=>c.toUpperCase());
        qs(root,'#caseOut').innerHTML = `<pre>${s}</pre>`;
      }
    }
  },

  "word-char-counter": {
    title:"Word & Character Counter",
    render:(root)=> {
      root.innerHTML = `
        <h2>Word & Character Counter</h2>
        <label>Paste text</label><textarea id="wcIn" rows="6"></textarea>
        <div style="margin-top:8px"><button id="wcBtn" class="primary">Count</button></div>
        <div id="wcOut" class="result"></div>
      `;
      qs(root,'#wcBtn').onclick = ()=>{
        const s = qs(root,'#wcIn').value||'';
        const chars = s.length;
        const words = s.trim()? s.trim().split(/\s+/).length : 0;
        const lines = s.split(/\r?\n/).length;
        qs(root,'#wcOut').innerHTML = `<div class="small">Words: ${words} • Characters: ${chars} • Lines: ${lines}</div>`;
      }
    }
  },

  "online-notepad": {
    title:"Online Notepad",
    render:(root)=> {
      root.innerHTML = `
        <h2>Online Notepad (local auto-save)</h2>
        <textarea id="note" rows="12"></textarea>
        <div style="margin-top:8px"><button id="saveNote" class="primary">Save Now</button> <button id="clearNote" class="toolbtn">Clear</button></div>
        <div id="noteMsg" class="result"></div>
      `;
      const ta = qs(root,'#note');
      ta.value = localStorage.getItem('smarttool_notepad')||'';
      ta.oninput = ()=> localStorage.setItem('smarttool_notepad', ta.value);
      qs(root,'#saveNote').onclick = ()=> { localStorage.setItem('smarttool_notepad',ta.value); qs(root,'#noteMsg').innerHTML=`<div class="small">Saved locally</div>`;}
      qs(root,'#clearNote').onclick = ()=> { if(confirm('Clear note?')) { ta.value=''; localStorage.removeItem('smarttool_notepad'); qs(root,'#noteMsg').innerHTML=''; } }
    }
  },

  // Data tools
  "json-formatter": {
    title:"JSON Formatter & Validator",
    render:(root)=>{
      root.innerHTML = `
        <h2>JSON Formatter & Validator</h2>
        <label>Paste JSON</label><textarea id="jsonIn" rows="10"></textarea>
        <div style="margin-top:8px"><button id="fmt" class="primary">Format</button> <button id="min" class="toolbtn">Minify</button></div>
        <div id="jsonOut" class="result"></div>
      `;
      qs(root,'#fmt').onclick = ()=> {
        try{ const obj = JSON.parse(qs(root,'#jsonIn').value); qs(root,'#jsonOut').innerHTML = `<pre>${JSON.stringify(obj,null,2)}</pre>`; } catch(e){ qs(root,'#jsonOut').innerHTML = `<div class="small">Invalid JSON: ${e.message}</div>`; }
      }
      qs(root,'#min').onclick = ()=> {
        try{ const obj = JSON.parse(qs(root,'#jsonIn').value); qs(root,'#jsonOut').innerHTML = `<pre>${JSON.stringify(obj)}</pre>`; } catch(e){ qs(root,'#jsonOut').innerHTML = `<div class="small">Invalid JSON</div>`; }
      }
    }
  },

  "csv-to-json": {
    title:"CSV → JSON",
    render:(root)=>{
      root.innerHTML = `
        <h2>CSV to JSON</h2>
        <label>Paste CSV</label><textarea id="csvIn" rows="8"></textarea>
        <div style="margin-top:8px"><button id="csv2json" class="primary">Convert</button></div>
        <div id="csvOut" class="result"></div>
      `;
      qs(root,'#csv2json').onclick = ()=>{
        const csv = qs(root,'#csvIn').value.trim();
        if(!csv) return;
        const lines = csv.split(/\r?\n/);
        const headers = lines.shift().split(',');
        const arr = lines.map(l=>{
          const parts = l.split(',');
          const obj = {};
          headers.forEach((h,i)=> obj[h.trim()] = (parts[i]||'').trim());
          return obj;
        });
        qs(root,'#csvOut').innerHTML = `<pre>${JSON.stringify(arr,null,2)}</pre>`;
      }
    }
  },

  "json-to-csv": {
    title:"JSON → CSV",
    render:(root)=>{
      root.innerHTML = `
        <h2>JSON to CSV</h2>
        <label>Paste JSON array</label><textarea id="j2cIn" rows="8"></textarea>
        <div style="margin-top:8px"><button id="j2cBtn" class="primary">Convert</button></div>
        <div id="j2cOut" class="result"></div>
      `;
      qs(root,'#j2cBtn').onclick = ()=>{
        try{
          const data = JSON.parse(qs(root,'#j2cIn').value);
          if(!Array.isArray(data)) return qs(root,'#j2cOut').innerHTML='<div class="small">Provide JSON array</div>';
          const keys = Array.from(data.reduce((s,o)=>{ Object.keys(o).forEach(k=>s.add(k)); return s; }, new Set()));
          const rows = [keys.join(',')];
          data.forEach(obj=>{
            rows.push(keys.map(k=> `"${(obj[k]||'').toString().replace(/"/g,'""')}"`).join(','));
          });
          const csv = rows.join('\n');
          qs(root,'#j2cOut').innerHTML = `<pre>${csv}</pre>`;
        } catch(e){ qs(root,'#j2cOut').innerHTML = `<div class="small">Invalid JSON</div>`}
      }
    }
  },

  "csv-to-excel": { title:"CSV→Excel", render: (r)=> tools["csv-to-json"].render(r) },
  "excel-to-csv": { title:"Excel→CSV", render: (r)=> {
    r.innerHTML = `<h2>Excel to CSV</h2><p class="small">Browser-side Excel parsing needs a library (xlsx). You can paste CSV or upload with server-side processing. For now use CSV->JSON tool.</p>`;
  }},

  "data-table-viewer": { title:"Data Table Viewer", render:(r)=> {
    r.innerHTML = `<h2>Data Table Viewer</h2><p class="small">Paste CSV into CSV→JSON tool then view results. (This tool is a helper placeholder).</p>`;
  }},

  // QR & Color
  "color-picker": {
    title:"Color Picker",
    render:(root)=>{
      root.innerHTML = `
        <h2>Color Picker</h2>
        <label>Pick a color</label><input id="cp" type="color" value="#06b6d4"/>
        <div style="margin-top:10px"><button id="cpBtn" class="primary">Copy HEX</button></div>
        <div id="cpOut" class="result"></div>
      `;
      qs(root,'#cpBtn').onclick = ()=> {
        const v = qs(root,'#cp').value;
        navigator.clipboard?.writeText(v).then(()=> qs(root,'#cpOut').innerHTML=`<div class="small">Copied ${v} to clipboard</div>`).catch(()=>qs(root,'#cpOut').innerHTML=`<div class="small">Copy failed: ${v}</div>`);
      }
    }
  },

  "qr-generator": {
    title:"QR Code Generator",
    render:(root)=>{
      root.innerHTML = `
        <h2>QR Generator</h2>
        <label>Text or URL</label><input id="qrInput" type="text" placeholder="https://..."/>
        <div style="margin-top:8px"><button id="qrBtn" class="primary">Generate</button></div>
        <div id="qrOut" class="result"></div>
      `;
      qs(root,'#qrBtn').onclick = ()=> {
        const v = qs(root,'#qrInput').value||'';
        const out = qs(root,'#qrOut'); out.innerHTML='';
        const canvas = document.createElement('canvas');
        QRCode.toCanvas(canvas, v, {width:360}, function (error) {
          if(error) { out.innerHTML='<div class="small">Error generating QR</div>'; console.error(error); return; }
          out.appendChild(canvas);
          const dl = document.createElement('button'); dl.className='primary'; dl.textContent='Download PNG';
          dl.onclick = ()=> download(canvas.toDataURL('image/png').split(',')[1] ? dataURLtoBlob(canvas.toDataURL()): null, 'qrcode.png');
          out.appendChild(dl);
        });
        function dataURLtoBlob(dataurl){
          const arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1];
          const bstr = atob(arr[1]); let n=bstr.length; const u8=new Uint8Array(n);
          while(n--) u8[n]=bstr.charCodeAt(n);
          return new Blob([u8],{type:mime});
        }
      }
    }
  },

  "qr-scanner": {
    title:"QR Scanner (image)",
    render:(root)=>{
      root.innerHTML = `
        <h2>QR Scanner (upload image)</h2>
        <label>Upload image with QR</label><input id="qrScanFile" type="file" accept="image/*"/>
        <div style="margin-top:8px"><button id="qrScanBtn" class="primary">Scan</button></div>
        <div id="qrScanOut" class="result"></div>
      `;
      qs(root,'#qrScanBtn').onclick = async ()=>{
        const f = qs(root,'#qrScanFile').files[0]; if(!f) return alert('Select image');
        // Use QRCode library to decode? Not included. Use jsQR? Not available. We'll fallback to using an external decoding API is not allowed.
        // So we attempt to draw image to canvas and use qrcode library decode isn't included -> limited.
        qs(root,'#qrScanOut').innerHTML = `<div class="small">QR scanning from image requires jsQR library which is not included. Please use QR Scanner on homepage (webcam) or add jsQR.</div>`;
      }
    }
  }

}; // end tools map

// Build toolbar
const toolbar = $('#toolbar');
Object.keys(tools).forEach(slug=>{
  const btn = document.createElement('button'); btn.className='toolbtn'; btn.innerHTML = `<i class="fa fa-circle"></i> ${tools[slug].title}`;
  btn.onclick = ()=> openTool(slug);
  toolbar.appendChild(btn);
});

// read ?tool=slug
const params = new URLSearchParams(location.search);
const requested = params.get('tool') || 'image-to-pdf';
function openTool(slug){
  if(!tools[slug]) { alert('Tool not found'); return; }
  // set active button style
  Array.from(toolbar.children).forEach(b=> b.classList.toggle('active', b.textContent.trim().startsWith(tools[slug].title)));
  const container = $('#ui'); container.innerHTML = `<div class="small">Loading ${tools[slug].title}...</div>`;
  document.getElementById('toolSlug').textContent = slug;
  // call render
  try{ tools[slug].render(container); } catch(e){ container.innerHTML = `<div class="small">Error loading tool: ${e.message}</div>`; console.error(e); }
  history.replaceState(null,'', '?tool='+slug);
}

// if initial slug exists
openTool(requested);

// helper download when canvas used (for QR)
function downloadDataURL(dataURL, name){
  const blob = (function(d){ const arr = d.split(','), mime = arr[0].match(/:(.*?);/)[1]; const bstr = atob(arr[1]); let n=bstr.length; const u8=new Uint8Array(n); while(n--) u8[n]=bstr.charCodeAt(n); return new Blob([u8],{type:mime}); })(dataURL);
  download(blob, name);
}

// expose selectCategory (for home index use)
window.selectCategory = (cat)=>{
  // find first tool matching category and open it
  const mapping = {
    pdf: 'pdf-merge',
    image: 'image-to-png-jpg',
    text: 'base64',
    data: 'json-formatter',
    qr: 'qr-generator',
    all: requested
  };
  const slug = mapping[cat] || requested;
  openTool(slug);
}

// add basic keyboard shortcut: Ctrl+K focus search on parent page if exists
</script>
</body>
</html>
