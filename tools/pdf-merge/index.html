<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Merge Multiple PDFs — Fixed Version</title>
<style>
  body { background: #121826; color: white; font-family: Arial, sans-serif; margin: 0; }
  header { background: #0ea5e9; padding: 10px; text-align: center; font-size: 1.5rem; }
  #fileInput { display: block; margin: 20px auto; }
  #dropZone { border: 2px dashed #0ea5e9; padding: 40px; text-align: center; margin: 20px; }
  #mergeBtn { display: block; margin: 20px auto; padding: 10px 20px; background: #6366f1; border: none; color: white; cursor: pointer; }
</style>
</head>
<body>
<header>Merge Multiple PDFs — Fixed Version</header>

<input type="file" id="fileInput" accept=".pdf,application/pdf" multiple>
<div id="dropZone">Drag & Drop PDF files here</div>
<button id="mergeBtn">Merge PDFs</button>

<script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>

<script>
let files = [];

document.getElementById('fileInput').addEventListener('change', (e) => {
  for (const file of e.target.files) {
    if (!file.name.toLowerCase().endsWith('.pdf')) {
      alert("Only PDF files allowed: " + file.name);
      continue;
    }
    files.push(file);
  }
});

const dropZone = document.getElementById('dropZone');
dropZone.addEventListener('dragover', (e) => {
  e.preventDefault();
  dropZone.style.borderColor = '#fff';
});
dropZone.addEventListener('dragleave', () => {
  dropZone.style.borderColor = '#0ea5e9';
});
dropZone.addEventListener('drop', (e) => {
  e.preventDefault();
  dropZone.style.borderColor = '#0ea5e9';
  for (const f of e.dataTransfer.files) {
    if (!f.name.toLowerCase().endsWith('.pdf')) {
      alert("Only PDF files allowed: " + f.name);
      continue;
    }
    files.push(f);
  }
});

document.getElementById('mergeBtn').addEventListener('click', async () => {
  if (files.length === 0) {
    alert("Please select at least one PDF file.");
    return;
  }

  const outPdf = await PDFLib.PDFDocument.create();
  let skipped = [];

  for (const it of files) {
    try {
      const bytes = await it.arrayBuffer();
      const src = await PDFLib.PDFDocument.load(bytes, { ignoreEncryption: true });
      const total = src.getPageCount();
      for (let p = 0; p < total; p++) {
        const [copiedPage] = await outPdf.copyPages(src, [p]);
        outPdf.addPage(copiedPage);
      }
    } catch (e) {
      console.warn("Skipping file (cannot parse):", it.name, e);
      skipped.push(it.name);
      continue;
    }
  }

  if (outPdf.getPageCount() === 0) {
    alert('Merging failed: all files were skipped (possibly encrypted/corrupt).');
    return;
  }

  if (skipped.length) {
    alert('Skipped files (could not parse):\n' + skipped.join('\n'));
  }

  const outBytes = await outPdf.save({ useObjectStreams: false });
  const blob = new Blob([outBytes], { type: 'application/pdf' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'merged.pdf';
  a.click();
});
</script>
</body>
</html>
